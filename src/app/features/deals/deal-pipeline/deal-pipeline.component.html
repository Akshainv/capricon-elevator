<!-- src/app/features/deals/deal-pipeline/deal-pipeline.component.html -->
<div class="pipeline-container">
  
  <div class="page-header">
    <div class="header-left">
      <h1>All Pending Deals</h1>
      <p>View and manage all your deals</p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Loading deals...</p>
  </div>

  <div *ngIf="!loading">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon total">
          <i class="fas fa-handshake"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Deals</div>
          <div class="stat-value">{{ allDeals.length }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon pending">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">Pending Deals</div>
          <div class="stat-value">{{ getPendingDealsCount() }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon converted">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">Converted Deals</div>
          <div class="stat-value">{{ getConvertedDealsCount() }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon average">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-amount">{{ formatCurrency(getTotalValue()) }}</div>
        </div>
      </div>
    </div>

    <div class="deals-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-list"></i>
          All Deals
          <span class="deals-count">{{ allDeals.length }}</span>
        </h2>
      </div>

      <div *ngIf="allDeals.length === 0" class="empty-state">
        <i class="fas fa-handshake"></i>
        <h3>No deals found</h3>
        <p>Convert quotations to deals to see them here</p>
      </div>

      <div class="won-deals-list">
        <div *ngFor="let deal of allDeals" class="won-deal-card" (click)="viewDealDetails(deal)">
          <div class="deal-status-indicator" [ngClass]="getStatusBadgeClass(deal)">
            <i class="fas" [ngClass]="{
              'fa-handshake': !deal.converted && deal.DealStatus !== 'won',
              'fa-trophy': deal.DealStatus === 'won' && !deal.converted,
              'fa-check-circle': deal.converted
            }"></i>
          </div>
          
          <div class="deal-content">
            <div class="deal-main-info">
              <div class="deal-left">
                <div class="deal-header-row">
                  <h3 class="deal-title">{{ getDealTitle(deal) }}</h3>
                  <div class="status-badges">
                    <span class="status-badge" [ngClass]="getStatusBadgeClass(deal)">
                      <i class="fas" [ngClass]="{
                        'fa-clock': !deal.converted && deal.DealStatus === 'pending',
                        'fa-check-circle': deal.DealStatus === 'won' || deal.converted,
                        'fa-times-circle': deal.DealStatus === 'lost'
                      }"></i>
                      {{ getStatusText(deal) }}
                    </span>
                    <span *ngIf="deal.createdFrom === 'quotation'" class="status-badge status-quotation">
                      <i class="fas fa-file-invoice"></i>
                      From Quotation
                    </span>
                  </div>
                </div>
                
                <div class="deal-details-grid">
                  <div class="detail-item">
                    <i class="fas fa-building"></i>
                    <span class="detail-label">Company:</span>
                    <span class="detail-value">{{ getDealCompany(deal) }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-elevator"></i>
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">{{ getDealElevatorType(deal) }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-user"></i>
                    <span class="detail-label">Contact:</span>
                    <span class="detail-value">{{ deal.contactPerson }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">{{ deal.phone }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ deal.email }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-user-tie"></i>
                    <span class="detail-label">Assigned To:</span>
                    <!-- âœ… Use getAssignedToName for proper display -->
                    <span class="detail-value">{{ getAssignedToName(deal) }}</span>
                  </div>
                  
                  <div class="detail-item" *ngIf="deal.quoteNumber">
                    <i class="fas fa-hashtag"></i>
                    <span class="detail-label">Quote #:</span>
                    <span class="detail-value">{{ deal.quoteNumber }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-calendar-check"></i>
                    <span class="detail-label">Close Date:</span>
                    <span class="detail-value">{{ formatDate(getDealExpectedCloseDate(deal)) }}</span>
                  </div>
                  
                  <div class="detail-item">
                    <i class="fas fa-percentage"></i>
                    <span class="detail-label">Success Rate:</span>
                    <span class="detail-value">{{ deal.Probability }}%</span>
                  </div>
                </div>
              </div>
              
              <div class="deal-right">
                <div class="deal-amount-section">
                  <div class="amount-label">Deal Value</div>
                  <div class="amount-value">{{ formatCurrency(deal.dealAmount) }}</div>
                  <div class="amount-status" [ngClass]="getStatusBadgeClass(deal)">
                    <i class="fas" [ngClass]="{
                      'fa-clock': !deal.converted,
                      'fa-check-circle': deal.converted
                    }"></i>
                    {{ deal.converted ? 'Converted to Project' : 'Ready to Convert' }}
                  </div>
                </div>
                
                <div class="deal-actions">
                  <button 
                    class="btn-convert" 
                    [class.btn-converted]="deal.converted"
                    [disabled]="deal.converted || loading"
                    (click)="convertToProject(deal); $event.stopPropagation()"
                  >
                    <i [class.fa-arrow-right]="!deal.converted" [class.fa-check]="deal.converted" class="fas"></i>
                    <span>{{ deal.converted ? 'Already Converted' : 'Convert to Project' }}</span>
                  </button>
                  
                  <button 
                    class="btn-view-details" 
                    (click)="viewDealDetails(deal); $event.stopPropagation()"
                  >
                    <i class="fas fa-eye"></i>
                    <span>View Details</span>
                  </button>

                  <button 
                    class="btn-delete"
                    [disabled]="deal.converted || loading"
                    (click)="deleteDeal(deal, $event)"
                    title="{{ deal.converted ? 'Cannot delete converted deals' : 'Delete deal' }}"
                  >
                    <i class="fas fa-trash"></i>
                    <span>Delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>